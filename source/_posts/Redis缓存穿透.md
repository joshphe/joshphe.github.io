---
title: Redis缓存穿透
date: 2020-05-12 23:05:28
tags:
---

### Redis缓存穿透

缓存穿透的概念很简单，用户想要查询一个数据，发现redis内存数据库没有，也就是缓存没有命中，于是向持久层数据库查询。发现也没有，于是本次查询失败。当用户很多的时候，缓存都没有命中，于是都去请求了持久层数据库。这会给持久层数据库造成很大的压力，这时候就相当于出现了缓存穿透。

**这里需要注意和缓存击穿的区别，缓存击穿，是指一个key非常热点，在不停的扛着大并发，大并发集中对这一个点进行访问，当这个key在失效的瞬间，持续的大并发就穿破缓存，直接请求数据库，就像在一个屏障上凿开了一个洞。**

#### 数据库瓶颈解决方法：减少数据库连接

1.	数据库连接池
2.	分库、分表
3.	数据库集群
4.	加缓存层

Redis是基于内存的数据库，响应速度极快，一般用于存放热门数据。

缓存穿透无法避免，但可以避免高频缓存穿透。444

#### 解决方案

##### 	（1）布隆过滤器

布隆过滤器是一种数据结构，垃圾网站和正常网站加起来全世界据统计也有几十亿个。网警要过滤这些垃圾网站，总不能到数据库里面一个一个去比较吧，这就可以使用布隆过滤器。假设我们存储一亿个垃圾网站地址。

布隆算法通过bit数组来标识数据，传给Hash函数计算Hash值，通过错误率来换取空间。

布隆算法是因为存在Hash碰撞，所以导致错误率。

降低错误率方法：

1. 增加Hash数组长度
2. 增加Hash函数的个数

### Hash函数的个数并不是越多越好，需要参考数组长度。

Hash函数特点：

1. Hash值范围[0,length-1]
2. 计算出来的Hash值足够散列

Hash错误率：

布隆算法说数据存在，那么实际可能不存在；数据不存在，则一定不存在。

#####		布隆算法弊端：删除数据

bit数组中的1值可能代表了多个id号，数组中的1值无法轻易的变为0。

通过二维计数器来解决这个问题，如果计数器的值为0，则可将1值变为0。

![](https://gitee.com/Qzjp/pics/raw/master/img/picture3.jpg)

**2、缓存空对象**

当存储层不命中后，即使返回的空对象也将其缓存起来，同时会设置一个过期时间，之后再访问这个数据将会从缓存中获取，保护了后端数据源；

![](https://gitee.com/Qzjp/pics/raw/master/img/picture4.jpg)

但是这种方法会存在两个问题：

如果空值能够被缓存起来，这就意味着缓存需要更多的空间存储更多的键，因为这当中可能会有很多的空值的键；即使对空值设置了过期时间，还是会存在缓存层和存储层的数据会有一段时间窗口的不一致，这对于需要保持一致性的业务会有影响。

**二、缓存雪崩**

1、概念

缓存雪崩是指，缓存层出现了错误，不能正常工作了。于是所有的请求都会达到存储层，存储层的调用量会暴增，造成存储层也会挂掉的情况。

![](https://gitee.com/Qzjp/pics/raw/master/img/picture5.jpg)

**2、解决方案**

**（1）redis高可用**

这个思想的含义是，既然redis有可能挂掉，那我多增设几台redis，这样一台挂掉之后其他的还可以继续工作，其实就是搭建的集群。

**（2）限流降级**

这个解决方案的思想是，在缓存失效后，通过加锁或者队列来控制读数据库写缓存的线程数量。比如对某个key只允许一个线程查询数据和写缓存，其他线程等待。

**（3）数据预热**

数据加热的含义就是在正式部署之前，我先把可能的数据先预先访问一遍，这样部分可能大量访问的数据就会加载到缓存中。在即将发生大并发访问前手动触发加载缓存不同的key，设置不同的过期时间，让缓存失效的时间点尽量均匀。

